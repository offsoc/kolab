version: '3'
services:
  proxy:
    depends_on:
      imap:
        condition: service_healthy
      postfix:
        condition: service_healthy
      webapp:
        condition: service_healthy
    build:
      context: ./docker/proxy/
    healthcheck:
      interval: 10s
      test: "kill -0 $$(cat /run/nginx.pid)"
      timeout: 5s
      retries: 30
    environment:
      - APP_WEBSITE_DOMAIN=${APP_WEBSITE_DOMAIN:?err}
      - SSL_CERTIFICATE=${PROXY_SSL_CERTIFICATE:?err}
      - SSL_CERTIFICATE_KEY=${PROXY_SSL_CERTIFICATE_KEY:?err}
    container_name: kolab-proxy
    restart: on-failure
    hostname: proxy
    image: kolab-proxy
    extra_hosts:
      - "meet:${MEET_LISTENING_HOST}"
    networks:
      kolab:
        ipv4_address: 172.18.0.7
    tmpfs:
      - /run
      - /tmp
      - /var/run
      - /var/tmp
    tty: true
    volumes:
      - ./docker/certs/:/etc/certs/:ro
      - /etc/letsencrypt/:/etc/letsencrypt/:ro
    ports:
      # - "25:25"
      # - "80:80"
      - "443:443"
      - "465:465"
      - "587:587"
      - "143:143"
      - "993:993"
  imap:
    build:
      context: ./docker/imap/
    environment:
      - APP_DOMAIN=${APP_DOMAIN}
      - IMAP_ADMIN_LOGIN=${IMAP_ADMIN_LOGIN}
      - IMAP_ADMIN_PASSWORD=${IMAP_ADMIN_PASSWORD}
    healthcheck:
      interval: 10s
      test: "kill -0 1"
      timeout: 5s
      retries: 30
    container_name: kolab-imap
    restart: on-failure
    hostname: imap
    image: kolab-imap
    networks:
      kolab:
        ipv4_address: 172.18.0.12
    extra_hosts:
      - "kolab.mgmt.com:127.0.0.1"
      - "services.${APP_DOMAIN}:172.18.0.4"
    tmpfs:
      - /run
      - /tmp
      - /var/run
      - /var/tmp
    tty: true
    volumes:
      - ./docker/certs/:/etc/certs/:ro
      - /etc/letsencrypt/:/etc/letsencrypt/:ro
      - imap-spool:/var/spool/imap
      - imap-lib:/var/lib/imap
    ports:
      - "11080:11080"
      - "11143:11143"
      - "11024:11024"
  postfix:
    build:
      context: ./docker/postfix/
    healthcheck:
      interval: 10s
      test: "kill -0 1"
      timeout: 5s
      retries: 30
    environment:
      - APP_DOMAIN=${APP_DOMAIN}
      - DB_HOST=mariadb
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_DATABASE}
      - LMTP_DESTINATION="imap:11024"
    container_name: kolab-postfix
    restart: on-failure
    hostname: postfix
    image: kolab-postfix
    networks:
      kolab:
        ipv4_address: 172.18.0.13
    extra_hosts:
      - "kolab.mgmt.com:127.0.0.1"
      - "services.${APP_DOMAIN}:172.18.0.4"
    tmpfs:
      - /run
      - /tmp
      - /var/run
      - /var/tmp
    tty: true
    volumes:
      - ./docker/certs/:/etc/certs/:ro
      - /etc/letsencrypt/:/etc/letsencrypt/:ro
      - postfix-spool:/var/spool/postfix
      - postfix-lib:/var/lib/postfix
    ports:
      - "10587:10587"
      - "10025:10025"
volumes:
  postfix-spool:
  postfix-lib:
  imap-spool:
  imap-lib:
