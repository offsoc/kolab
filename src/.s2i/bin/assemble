#!/bin/bash

set -x
set -e

function app_source () {
    echo "---> Installing application source..."
    rm -fR /tmp/src/.git
    mv /tmp/src /opt/app-root/
}

function composer_install () {
    echo "--->> Detected composer.json, running install"
    php -dmemory_limit=${COMPOSER_MEMORY_LIMIT:--1} /usr/bin/composer install ${COMPOSER_ARGS}
    rm -rf ~/.cache/composer/
}

fix-permissions

shopt -s dotglob
echo "--->> $(rm -vrf vendor/ composer.lock)"

app_source

pushd /opt/app-root/src

if [ -f ".env.local" ]; then
    # Ensure there's a line ending
    echo "---->> Append .env.local"
    echo "" >> .env
    cat .env.local >> .env
fi

env

if [ -f "composer.json" ]; then
    echo "--->> Detected composer.json, running install"
    composer_install
fi

pwd

echo "---->> Run npm run prod"
npm install
npm run ${LARAVEL_ENV:=prod} && rm -rf ~/.npm/

