#!/bin/bash

set -x
set -e

function composer_install () {
    echo "--->> Detected composer.json, running install"
    php -dmemory_limit=${COMPOSER_MEMORY_LIMIT:--1} /usr/bin/composer install ${COMPOSER_ARGS}
    rm -rf ~/.cache/composer/
}

shopt -s dotglob
echo "--->> $(rm -vrf vendor/ composer.lock)"

echo "---> Installing application source..."
rm -fR /tmp/src/.git
mv /tmp/src/* ./

pushd /opt/app-root/src

fix-permissions ./

if [ -f ".env.local" ]; then
    # Ensure there's a line ending
    echo "---->> Append .env.local"
    echo "" >> .env
    cat .env.local >> .env
fi

if [ -f "composer.json" ]; then
    echo "--->> Detected composer.json, running install"
    composer_install
fi

./artisan horizon:install

if [ ! -z "${OPENEXCHANGERATES_API_KEY}" ]; then
    ./artisan data:import:open-exchange-rates
fi

echo "---->> Run npm run prod"
npm install
npm run ${LARAVEL_ENV:=prod} && rm -rf ~/.npm/

fix-permissions ./
