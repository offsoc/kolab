#!/bin/bash

set -e

shopt -s dotglob
echo "--->> $(rm -vrf vendor/ composer.lock)"

if [ -f ".env.local" ]; then
    # Ensure there's a line ending
    echo "---->> Append .env.local"
    echo "" >> .env
    cat .env.local >> .env
fi

env

ls -la /tmp/scripts/

echo "--->> Run stock assemble script ${ASSEMBLE_SCRIPT:=/usr/libexec/s2i/assemble}"

if [[ -f "${ASSEMBLE_SCRIPT}" || -f "/tmp/src/${ASSEMBLE_SCRIPT}" ]]; then
    ${ASSEMBLE_SCRIPT}
else
    echo "--->> ${ASSEMBLE_SCRIPT} does not exist"
fi

#cat >> /opt/app-root/etc/conf.d/99-loglevel.conf << EOF
#LogLevel warn mod_rewrite.c:trace4
#EOF

# Won't work due to:
# Cannot install, php_dir for channel "pecl.php.net" is not writeable by the current user
#pecl channel-update pecl.php.net
#pecl install swoole

pushd /opt/app-root/src

echo "---->> Run npm run prod"
npm install cross-env
npm run prod

