#!/bin/bash

set -e

shopt -s dotglob
echo "--->> $(rm -vrf vendor/ composer.lock)"

if [ -f ".env.local" ]; then
    # Ensure there's a line ending
    echo "---->> Append .env.local"
    echo "" >> .env
    cat .env.local >> .env
fi

#env

/usr/libexec/s2i/assemble

cat >> /opt/app-root/etc/conf.d/99-loglevel.conf << EOF
LogLevel debug mod_rewrite.c:trace2
EOF

# Won't work due to:
# Cannot install, php_dir for channel "pecl.php.net" is not writeable by the current user
#pecl channel-update pecl.php.net
#pecl install swoole

pushd /opt/app-root/src

echo "---->> Run npm run prod"
npm install cross-env
npm run prod

